<!DOCTYPE html>
<html>
<head>
	<title></title>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">


	<style>


		.container {
			margin-top: 10px;
		}

		.col-md-9 {
			border-style: solid;
		}

	</style>


</head>
<body>


	<div class="container">


		<div class="row">
			<div class="col-md-3">

				<form id="search-form">
					<input type="text" class="form-control" id="query" placeholder="Address..."></br>
					<button class="btn btn-primary pull-right" id="query" type="submit">Submit</button>
				</form>

			</div>

			<div class="col-md-9" id="result">
				
			</div>

		</div>

	</div>

	<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

	<script>

		(function(global) {
			var url = 'http://api.nestoria.co.uk/api?' +
			'country=uk&' +
			'pretty=1&' + 
			'action=search_listings&' +
			'encoding=json' +
			'&listing_type=buy&' +
			'page=1&' +
			'number_of_results=6';

			var nestoriaApi = {
				getLocations: function (placeName, successCallback, errorCallback) {
					$.ajax({
						url: url + '&place_name=' + placeName,
						type: 'GET',
						dataType: "jsonp",
						success: successCallback,
						error: errorCallback
					});
				}
			};

			global.nestoriaApi = nestoriaApi;
		})(window);




		$(function() {
			// находим форму
			var $searchForm = $("#search-form"); 
		 	// находим input
		 	var $query = $("#query");


		 	var queryText = (function(){
		 		var value = '';
		 		return {
		 			get: function() {
		 				return value;
		 			},
		 			set: function(val) {
		 				_value = val;
		 				$query.trigger('querytext:change', val);
		 			}
		 		}
		 	})();





		 	var showBuildingsList = function (response) {
		 		//console.info('showBuildingsList', response);


		 		var elements = response.listings;

		 		var fE = function(elements){
		 			$('#result').append('<li> <img src=' + elements.img_url + ' style="height: 100px;">');
		 			$('#result').append('<h2>'+elements.price_formatted+'</h2>');
		 			$('#result').append('<h3>'+elements.title+'</h3>');
		 			$('#result').append('<h4>'+elements.summary+'</h4> </li>');
		 		};

		 		elements.forEach(fE);


				console.log( response );



/*		 		response.listings[0].img_url
		 		response.listings[0].price_formatted
		 		response.listings[0].title
		 		response.listings[0].summary*/		 	



		 	};
		 	var showLocationsList = function (response) {
		 		//console.info('showLocationsList', response);	



		 	};
		 	var showErrorsList = function (response) {
		 		console.info('showErrorsList', response);	
		 	};




		 	// создаем функцию callback для submit формы
		 	var onSubmitHundler = function onSubmitHundler(event) {
		 			// this - объект элемента на котором произошло событие
		 			//var inputValue = $query.val();
		 			queryText.set($query.val());

		 			// отмена стандартного поведения перезагрузки страницы
		 			event.preventDefault();
		 		};



		 		var onChangeQueryText = function(event, text){
		 			//console.log('onChangeQueryText');
		 			var callbackSuccess = function(data){
		 				switch (data.response.application_response_code){
		 					case '100':
		 					case '101':
		 					case '110':
		 					showBuildingsList(data.response);
		 					break;

		 					case '200':
		 					case '202':
		 					showLocationsList(data.response);
		 					break;
		 					default: 
		 					showErrorsList(data.response);
		 				};

		 			};
		 			var callbackError = function(data){
		 				console.error(data);
		 			};
		 			nestoriaApi.getLocations(text, callbackSuccess, callbackError);

		 			event.preventDefault();
		 		};



		 		$searchForm.on('submit', onSubmitHundler);	
		 		$query.on('querytext:change', onChangeQueryText);



		 	});







</script>

<!-- add LiveReload function -->
<script>
	document.write('<script src="http://' + (location.host || 'localhost')
		.split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')
</script>


</body>
</html>